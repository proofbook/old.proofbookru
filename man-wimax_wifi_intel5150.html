<html>
            <head>
                <title>Ноутбуки: какие они снаружи и внутри &mdash; Установка wimax карты intel 5150 в ноутбук Lenovo X201. Внесение изменений в биос.</title>
                <meta charset="utf-8">
            </head>
            <body>
            <h1><a href="/">Ноутбуки: какие они снаружи и внутри</a> / Установка wimax карты intel 5150 в ноутбук Lenovo X201. Внесение изменений в биос.</h1>
            <div class="tags" style="display: none">bios, ibm, intel, intel 5150, leovo, manual, whitelist, wifi, wimax, полезные советы</div>
            <div class="date" style="display: none">Fri, 05 Nov 2010 10:39:07 +0000</div>
            <div class="contents"><p>Попался мне как-то в руки в личное пользование ноутбук <a href="http://habrahabr.ru/blogs/laptop/98787/">Lenovo X201</a> — отличная рабочая машинка.</p><p>Всё в нём вроде хорошо и всё вроде есть, но как обычно хочется большего —  захотелось встроенный WiMax иметь (3G модем уже в нём есть и довольно  хорошо работает).</p><p style="text-align: center;"><img class="aligncenter" src="http://img-fotki.yandex.ru/get/6002/proofbook.36/0_45736_841aa593_L.jpg" alt="установка intel 5150 в ноутбук ibm x201. изменение bios" width="400" height="300" /></p><p style="text-align: left;"><p>Для WiMax была приобретена карта Intel WiMax/Wifi Link 5150 PCIe Mini Card.</p><p>После установки выяснилось, что оказывается большинство современных  ноутбуков (в частности Lenovo) имеют White-list устройств, которые они  поддерживают. Сделано это видимо для того, чтоб пользователи покупали  только фирменные устройства в фирменных магазинах. Честно говоря я бы  рад купить такое устройство, если бы у нас они свободно продавались  (поправьте меня, если это так, может я не достаточно хорошо искал).</p><p>В частности мой ноутбук расстроился, увидев, что карточки, которую я ему подсунул нет в White-list и выдал мессагу:</p><code>1802: Unauthorized network card is plugged in - Power off and remove the miniPCI network card.</code><p>В случае установки неподдерживаемого 3G модема, вы получите сообщение:</p><code>1804: Unauthorized WAN card is plugged in - Power off and remove the WAN card.</code><!--more--><p>Сразу хочу обратить внимание на одну особенность, для тех кто не знает.  Фактически WiFi и WiMax будучи на одной плате, подключены по двум разным  каналам — один PCIe, второй USB соответственно.</p><p></p><p>Может это кого-то удивит (как, например, меня ранее) — WiMax подключен  именно через USB-шину, хотя оба устройства находятся на одной плате.  Такое подключение не очевидно и самое главное — наличие распайки USB на  PCIe разъёме не является обязательным (на чём я и накололся в ноутбуке  Lenovo x61s) — надо проверять или тестером или читать внутренние доки.</p><p>Немного информации о USB на разъёме mini-PCIe есть на <a href="http://ru.wikipedia.org/wiki/PCI_Express#Mini_PCI-E">Википедии</a> — выводы 36, 38.</p><p></p><p>И кстати такая гибридная карточка (по крайней мере моя) не может  работать в двух режимах сразу. Т.е. или wifi или wimax, переключение  программное. Это в теории может вызвать проблемы, связанные с включением  подачи питания на карту. Проблемы, судя по форумам решаемые, но такое  ощущение что без паяльника не обойтись. У меня к счастью — обошлось.</p><p></p><p>Так что если вдруг эта статья кого-то сподвигнет на покупку Wifi/Wimax  карты — надо бы сначала убедиться в том, что в PCIe разъёме  действительно есть USB иначе придётся довольно капитально погемороиться.</p><p>Несмотря на отсутствие USB, некоторые умельцы всё же умудрялись развести  USB на MiniPCI — для этого всего лишь нужно желание, руки, провода,  паяльник и схема, но это имхо уже экстрим.</p><p></p><p>Началось исследование проблемы с форума:</p><p>(1) <a href="http://forum.thinkpads.com/viewtopic.php?t=55837">forum.thinkpads.com/viewtopic.php?t=55837</a></p><p>а в последствии</p><p>(2) <a href="http://www.thinkwiki.org/wiki/Problem_with_unauthorized_MiniPCI_network_card">www.thinkwiki.org/wiki/Problem_with_unauthorized_MiniPCI_network_card</a></p><p>(3) <a href="http://web.dodds.net/%7Evorlon/wiki/blog/Upgrading_a_ThinkPad_BIOS.html">http://web.dodds.net/~vorlon/wiki/blog/Upgrading_a_ThinkPad_BIOS.html</a></p><p>(4) <a href="http://www.endeer.cz/bios.tools/">www.endeer.cz/bios.tools/</a></p><p>(5) <a href="http://www.endeer.cz/bios.tools/bios.html">www.endeer.cz/bios.tools/bios.html</a></p><p>(6) <a href="http://forums.mydigitallife.info/threads/20223-Remove-whitelist-check-add-ID-s-to-break-hardware-restrictions-mod-requests.?p=338719#post338719">http://forums.mydigitallife.info/threads/20223-Remove-whitelist-check-add-ID-s-to-break-hardware-restrictions-mod-requests.?p=338719#post338719</a></p><p>(7) <a href="http://www.endeer.cz/bios.tools/modz.html?machine=ALL">www.endeer.cz/bios.tools/modz.html?machine=ALL</a></p><p></p><p>У меня оказался довольно сложный случай — BIOS новой модификации и  способы типа правки пары байт в CMOS уже не работали, а так же не было  готового BIOS для моей модели по ссылке (7). В моём случае имелось 3  способа решить проблему:</p><p>1) Отключение проверки white-list</p><p>2) Вписание VEN/DEV/SUBSYS от моей карточки в white-list в замен какой-нибудь ненужной карты</p><p>3) Изменение VEN/DEV/SUBSYS в моей карте на те, которые уже есть в white-list.</p><p></p><p>Третий способ выглядел как-то не красиво и грозил возникновением проблем с дровами.</p><p>Второй способ был соблазнительным и казался проще — т.к. не надо  заморачиваться с поиском ASM-кода и изготовлением патча, но всё же я  нацелился на первый способ — т.к. он более универсальный и красивый.</p><p></p><p>Решать какой способ выбрать вам. Способ 3 описан по ссылке (2).</p><p>Способ 2 — тупо замена последовательности байт на интересующие.  Контрольная сумма биоса, как я понял, особо нигде не проверяется, по  крайней мере для моей версии. Возможно, есть какие-нибудь ловушки, но  т.к. я не пробовал пойти этим путём — я о них не знаю.</p><p></p><p>Почитав ссылки (4), (5) я вроде вдохнивился идеей самостоятельно сделать  патченый биос, но спустя несколько часов работы с инструментами по 4-ой  ссылке + IDA немного устал и вообще подумывал забить на эту идею.</p><p>Однако строчка, увиденная по ссылке (3) вдруг открыла второе дыхание</p><img src="http://img-fotki.yandex.ru/get/5902/proofbook.36/0_45737_9dbd703c_XL.jpg" alt="установка intel 5150 в ноутбук ibm x201. изменение bios" width="691" height="70" /><p></p><p>Я ещё раз более внимательно прочитал содержимое ссылок (4) и (5) и  потихоньку начал ковырять BIOS. Я не буду переводить то, что там  написано, т.к. к сожалению у автора этих страниц по моему мнению не  очень всё хорошо с доступностью изложения и вообще доступностью  информации (хотя статьи грамотные), да и я не совсем понял часть статьи,  касающейся собственно поиску кода и продумывания замены. Наверное,  будучи заядлым знатоком IDA и ассемблера можно понять, что он пишет — но  в вопросах биоса я бы лучше несколько раз отмерил, чем один раз  неудачно отрезал (был печальный опыт). Так же есть ощущения, что  информация в статье немного устарела. Знания ассемблера, конечно, у меня  небольшие были, но их явно не достаточно, чтоб понять, что нужно  сделать.</p><p></p><p>В общем мои изыскания ни к чему понятному не привели, но к счастью в  нужный момент, когда я уже почти опустил во второй раз руки, мне помог  хороший знакомый <a href="http://kmeaw.habrahabr.ru/">kmeaw</a> — и довольно быстро нашёл функцию проверки на White-list в нужном файле  и подправил несколько байт. На этом лирическую часть я, наверное,  закончу и приступлю к описанию моих действий.</p><p></p><p>Небольшое предупреждение.</p></p><p></p><h4>ВСЕ ДАЛЬНЕЙШИЕ ДЕЙСТВИЯ ВЫ ДЕЛАЕТЕ НА СВОЙ СТРАХ И РИСК!!!</h4><p>Работа с BIOS (особенно если вы всё делаете самостоятельно) очень ответственный и опасный процесс.</p><p>Все описанные ниже действия относятся к BIOS v1.22 для Lenovo X201 и  могут отличатся от действий, необходимых для других ноутбуков, хотя я и  постараюсь описать общий принцип.</p><p>Все утилиты для работы с BIOS можно найти по ссылке в конце статьи.</p><p></p><p>Хак биоса состоит из нескольких этапов:</p><p>1) Скачивание, распаковка, декомпановка по модулям.</p><p>2) Поиск функций проверки (для WAN — одна функция, для WWAN — другая)</p><p>3) Организация обхода функций проверки</p><p>4) Подгонка запакованной версии файла под размер исходной версии (размер должен совпадать)</p><p>5) Внесение изменений в основной модуль биоса, путём сравненис исходной и патченой версии модуля.</p><p></p><p>Начнём.</p><h5>(1) Скачивание, распаковка, декомпановка по модулям.</h5><p>Первое что нужно сделать — надо получить собственно сам файл с BIOS для дальнейшей работы. Сделать это можно двумя способами:</p><p>* Сделать бекап текущего биоса и с ним работать. Этим способом я  почему-то решил не пользоваться и ничего по поводу него я рассказать не  могу.</p><p>* Скачать с официального сайта <a href="http://download.lenovo.com/ibmdl/pub/pc/pccbbs/mobiles/6quj08us.exe">файл</a> с прошивкой, распаковать.</p><p></p><p>Интересующий файл $01C2100.FL1 будет лежать по адресу \DRIVERS\FLASH\6quj08us\6QET52WW</p><p>Данный файл является сжатым образом системного биоса. Все остальные  файлы (отличные от FL1) относятся к каким-то другим частям системы,  которыми я не интересовался и не знаю для чего они предназначены — в  дальнейшем они не особо нужны.</p><p></p><p>После того, как интересующий файл будет найден, необходимо будет его распаковать.</p><p>Для этого необходимо ввести команду:</p><code>phcomp /D $01C2100.FL1</code><p>Затем необходимо полученный файл распотрошить на модули с помощью команды</p><code>phnxsplit.exe $01C2100.FLh</code><p>(для работы phnxsplit.exe необходима библиотека cygwin1.dll)</p><p>Думаю, тут стоит обратить внимание на то, что бОльшая часть файлов, была  распакована по алгоритму lzint и чтоб вернуть всё обратно — надо  исправленный файл запаковать обратно — но об этом позже.</p><h5>(2) Поиск функций проверки (для WAN — одна функция, для WWAN — другая)</h5><p>После выполнения команды, вы получите кучу файлов с расширением *.rom.  Среди этого безобразия, нужно найти нужный файл, над которым мы будем в  дальнейшем издеваться. В первую очередь, нужно найти устройство, которое  100% есть в while-list. Для этого нужно (далее будет описан способ для  XP, если у вас другая ОС — попробуйте найти способ узнать данные  самостоятельно) зайти в</p><p>«диспетчер устройств\(wifi устройство или 3g модем)\сведения\код экземпляра устройства»</p><p>Пусть, например, это будет:</p><code>Intel Wifi Link 1000BGN, PCI\VEN_8086&amp;DEV_0084&amp;SUBSYS_13158086&amp;REV_00</code><p>Интересующие данные это:</p><code>VEN_8086&amp;DEV_0084&amp;SUBSYS_13158086</code><p>Из этого получается такая строка для поиска:</p><code>0x8680840086801513</code><p>В случае для 3G модема</p><code>0xc6050592</code><p>Думаю понятно, как это получилось (обратный порядок байтов для каждой части записи).</p><p>Можете воспользоваться прям этой строчкой из примера, думаю она должна быть в вашем биосе.</p><p></p><p>После получения такой строчки, нужно как-то поискать во всех  распакованных файлах. Скорее всего это будет один файл BIOSCODEXX.rom</p><p>Я лично это сделал с помощью FAR (Alt+F7, искать 16-ричный код).</p><p></p><p>В моём случае файлом с интересующей функцией проверки оказался файл BIOSCODE06.rom</p><p>Тут начинается самое интересное.</p><p>Открыв его через IDA я довольно долго пытался понять то, что говорится  по ссылке (5). Кстати открывать файл с биосом нужно предварительно  переименовав исходный файл в файл с расширением .hex.</p><p>Файл состоит из 27-байтового заголовка и тела бинарного 16-ричного  приложения. В заголовке имеется указание на смещение, относительно  основного BIOS-а. Что я понял — смещение указано там, поскольку при  работе все модули находятся в одной области памяти и указатели на  функции в модуле ссылаются с учётом смещения.</p><h5>(3) Организация обхода функций проверки</h5><p>На практике оказалось, что в интересующей нас части кода, все jmp на  функции — относительные и смещение не играет никакого значения.</p><p>Попытки разобраться в модуле самостоятельно ни к чему не привели — из-за  отсутствия даже минимального опыта в вопросах дизассемблирования, не  смотря на небольшие знания ассемблера, поэтому пришлось обратиться к  знакомому за советом.</p><p>Спустя 10 минут он прислал мне такой скриншот</p><img src="http://img-fotki.yandex.ru/get/4603/proofbook.36/0_45735_e5740f6_XL.jpg" alt="установка intel 5150 в ноутбук ibm x201. изменение bios" width="640" height="400" /><p>Скриншот собственно содержал то, что нужно поправить.</p><p></p><p>Увидев скриншот, я решил воспользоваться в дальнейшем hiew 6.50 (который  можно найти в архиве) для редактирования файла, т.к. он оказался проще  чем IDM.</p><p>Небольшая справка по использованию HIEW:</p><code>F4 - Изменение режима (Text, Hex, Decode)<p>------ Изменения удобней вносить в режиме Hex</p><p>------ Анализировать работу кода - в режиме Decode</p><p>------ В режиме Hex доступна комбинация Ctrl+F5</p><p>Ctrl+F5 - Установка смещений. На скриншоте указаны адреса без учёта  27-байтового заголовка. Для установки таких же смещений, необходимо  указать смещение -1B</p><p>F5 - Переход на смещение (указывается в hex)</p><p>F3 - Редактирование</p><p>F9 - Сохранение.</p></code><p></p><p>Правка, изображённая на скриншоте, довольно понятная и простая, после того, как была найдена функция проверки white-list.</p><p>Функция вызывается только из одного места, имеет чёткие границы.  Изменение заключается в том, что в начале работы функции происходит jmp  на конец функции. Выходные данные при этом выглядят как будто карта  успешно прошла проверку.</p><p>Вроде функцию проверки убили, казалось бы всё, но нет — функция отвечала  только за карты Wifi/Wimax (ошибка 1802). Есть ещё одна функция — для  проверки WAN (ошибка 1804). На её поиск ушло не много времени — принцип  оказался идентичным, зато изготовление патча заняло значительное время,  поскольку после правки, модуль в сжатом виде никак не хотел становиться  нужного размера (того же размера, что и был до внесения изменений).</p><p></p><p>Одинаковый размер необходим из-за того, что утилита phnxmod.exe, которая  в дальнейшем производит подмену модуля в файле $01C2100.FLh, не может  работать с файлами, если новый отличается от старого хотя бы на байт.</p><p></p><p>Собственно для того, чтоб внести необходимое изменение и подогнать  размер, пришлось много что поправить и затереть кусок функции проверки  (благо после добавления jmp, она больше не требовалась).</p><p>Результат на картинке:</p><img src="http://img-fotki.yandex.ru/get/5900/proofbook.36/0_4574e_23150209_XL.jpg" alt="установка intel 5150 в ноутбук ibm x201. изменение bios" width="640" height="800" /><p>Верхний скриншот — обход для функции проверки WAN-карт.</p><p>Нижний скриншот — обход для функций проверки Wfi/Wimax-карт.</p><h5>(4) Подгонка запакованной версии файла под размер исходной версии</h5><p>Изменение было внесено в файл, после файл был обратно запакован.</p><p>Стоит отметить, что запаковка файла производится не командой phcomp, как можно подумать. А набором команд из комплекта к BIOS.</p><code>Для старых это - prepare.exe<p>------ файл обычно есть в комплекте с скачанным биосом, для упаковки, нужно создать файл-скрипт.</p><p>------ Пример скрипта можно найти так же в комплекте с биосом, называется logo.scr. В файле нужно</p><p>------ заменить "LOGO logo.." на "BIOSCODE file.rom"</p><p>Для новых это - fi.exe, fp.exe, ceimain.bin, rom2mod.exe</p><p>------ файлы обычно есть в комплекте с скачанным биосом, для упаковки, нужно создать файл-скрипт.</p><p>------ Пример скрипта можно найти так же в комплекте с биосом, называется logo.scr. В файле нужно</p><p>------ заменить"LOGO logo.." на "BIOSCODE file.rom"</p><p>------ Пример скрипта для linux с использованием wine можно взять <a href="http://web.dodds.net/%7Evorlon/phoenix_bios_prepare_module">тут</a></p></code><p>Определить старый от нового — вы сможете по тому, что идёт в комплекте с биосом, в папке \DRIVERS\FLASH\6quj08us</p><p>В общем я с этим довольно долго провозился, пока понял. В конце статьи  есть готовый набор утилит для упаковки патченного файла в частности для  моего BIOS-а с bat-ником (на основе logo.bat).</p><p></p><p>Так же, необходимо упаковать исходный файл, который у меня назывался BIOSCODE06.rom</p><p>В итоге получилось два файла BIOSCODE06.rom-lz (патченный), BIOSCODE06.rom-orig-lz (оригинальный) одинакового размера.</p><h5>(5) Внесение изменений в основной модуль биоса, путём сравненис исходной и патченой версии модуля.</h5><p>Последним шагом на пути к готовому патченому биосу является подмена модуля в компанованном основном файле биоса $01C2100.FLh</p><p></p><p>Для этого, необходимо воспользоваться командой:</p><code>phnxmod.exe 01C2100.FLh BIOSCODE06.ro2 BIOSCODE06.ro2.patched</code><p>Синтаксис такой:</p><p>phnxmod.exe (распакованная версия $01C2100.FL1) (оригинальный запакованный модуль) (модифицированный запакованный модуль).</p><p></p><p>После выполнения команды, вы должны увидеть примерно такое сообщение:</p><code>Okay, all files open.<p>ROM size 200000h, old module 7B66h+1Bh, new module 7B66h+1Bh.</p><p>Loading data...Old module (without header) found at 1EA565h. Replaced.</p><p>Writing modified ROM back... Done.</p><p></p><p>---------------- WARNING! ----------------</p><p>If you don't know what you're doing there's a very high risk of rendering your</p><p>computer unusable by flashing a modified BIOS. This is not a safe playground.</p><p>---------------- WARNING! ----------------</p></code><p>Это последний этап хака.</p><p></p><p>Полученный патченный файл $01C2100.FLh можно использовать для перепрошивки с помощью WinPhlash.</p><p>Я для этого взял <a href="http://mods.myftp.org/Lenovo/ThinkPad%20T400s/ThinkPad_T400s_6huj13us_u6_no_whitelist.rar">архив</a> с ссылки (6), подправил rom-файл и конфиг и перепрошил свой ноут.</p><p></p><p>После перепрошивки я успешно запустил неподдерживаемую Wimax/wifi карту  на своём ноуте, проверил подключение к Wifi, Wimax (Комстар, Yota) — всё  отлично.</p><p></p><p>Так же был проверен 3G-модуль Sierra MC8775, который не должен  поддерживаться на этой модели. Ноутбук успешно загрузился. После  установки драйверов удалось успешно подключиться к 3G сети.</p><p></p><p>Файлы:</p><p>1. <a href="http://www.mafet.ru/x201/Lenovo_X201_6quj08us_no_whitelist.rar">Готовый архив с патченым BIOS 1.22 для Lenovo X201 (no white-list) bypass 1802/1804 error</a></p><code>Инструкция по установке:<p>Запустить WinPhlash.exe из архива. Открыть "Advanced Settings" и проверить соответствие чек-боксов и параметров обновления:</p><p></p><p>("Flags" Tab):</p><p>[ ] Verify BIOS part number</p><p>[ ] Flash only if BIOS version is different</p><p>[ ] Flash only if BIOS version is newer</p><p>[ ] Verify BIOS image size</p><p>[ ] Verify BIOS checksum</p><p>[ ] Zero block before erasing</p><p>[x] Verify block after programming</p><p>[x] Disable Axx swaping automatic detection (if present)</p><p>[ ] Clear CMOS Checksum</p><p></p><p>("DMI" tab)</p><p>"Update": Select "Update the BIOS and not DMI"</p></code><p>2. <a href="http://www.mafet.ru/x201/Lenovo_X201_6quj08us_patchedfiles.rar">Патченный файл BIOSCODE06.rom</a> ($01C2100.FLh в архиве уже патченый)</p><p>3. <a href="http://www.mafet.ru/x201/phbios-tools.rar">Набор утилит для работы с BIOS</a></p><p>4. <a href="http://www.mafet.ru/x201/prepare-compress.rar">Утилиты для упаковки модуля</a></p><p></p><p>В заключении хочу ещё раз напомнить, что всё, что вы делаете с BIOS —  очень ответственно и серъёзно. Если возникает неуверенность в чём-то —  лучше сто раз перепроверить и убедиться, что вы всё делаете правильно.  При перепрошивке — обязательно выключите все программы и приложения  (если вы прошиваетесь из windows), а лучше — прошиваться с загрузочного  CD или флешки. Так же, лучше использовать уже патченные и проверенные  версии BIOS (можно попробовать найти по ссылке (7), чем делать их  самостоятельно, а если уж и делать — прочитать как можно больше  информации, кроме этой статьи как минимум по ссылкам, указанным выше.</p><p></p><strong>upd:</strong> <a title="upgrading thinkpad bios" href="http://web.dodds.net/~vorlon/wiki/blog/Upgrading_a_ThinkPad_BIOS.html" target="_blank">Как проделать подобное из linux. </a><p></p><hr /><a href="http://habrahabr.ru/blogs/DIY/107598/" target="_blank">Оригинал статьи</a>, автор <a href="http://mafet.habrahabr.ru/" target="_blank">mafet</a>.<p></p><hr /></div>
            </body>
        </html>